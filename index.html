<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blackbox Video Exporter</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <input type="file" class="fileInput"><br>
  <canvas class="canvas" style="height: 500px; border: 1px solid #000;"></canvas>
  <script>
    window.settings = {};
    settings.height = 900;
    settings.width = 200;
    settings.padding = 10;
    settings.borderRadius = 10;
    settings.background = '#222';
    settings.background2 = '#333';
    settings.color = '#f33';
    settings.accent = '#fff';
    settings.font = '20px arial';

    
    settings.fileInput = document.querySelector('.fileInput');
    settings.canvas = document.querySelector('.canvas');
    settings.canvas.width = settings.width;
    settings.canvas.height = settings.height;
    settings.ctx = settings.canvas.getContext('2d');
  </script>
  <script>
    //https://stackoverflow.com/questions/1255512/how-to-draw-a-rounded-rectangle-on-html-canvas
    CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
      if (w < 2 * r) r = w / 2;
      if (h < 2 * r) r = h / 2;
      this.beginPath();
      this.moveTo(x+r, y);
      this.arcTo(x+w, y,   x+w, y+h, r);
      this.arcTo(x+w, y+h, x,   y+h, r);
      this.arcTo(x,   y+h, x,   y,   r);
      this.arcTo(x,   y,   x+w, y,   r);
      this.closePath();
      return this;
    }
  </script>
  <script src="CSVParser.js"></script>
  <script src="stickOverlay.js"></script>
  <script src="videoConverter.js"></script>
  <script>
    //https://www.geeksforgeeks.org/how-to-read-a-local-text-file-using-javascript/
    settings.fileInput.onchange = function(){
      if(this.files.length != 1){
        throw new Error('Please only select one file.');
      }
      console.log('Reading...');
      var reader = new FileReader();
      reader.onload = function(){
        console.log('Parsing...');
        var data = parse(reader.result);
        console.log(data);
        console.log('Animating...');
        animate(data);
      }
      reader.readAsBinaryString(this.files[0]);
    }
    function parse(text){
      var dataHeader;
      var obj = CSVParser.parse(text, function(obj, arr){
        if(arr[0] == 'loopIteration'){
          dataHeader = arr;
          obj.data = [];
          return;
        }
        if(dataHeader){
          item = {};
          for(var h = 0; h < dataHeader.length; h++)
            item[dataHeader[h]] = arr[h];
          obj.data.push(item);
        }else obj[arr[0]] = arr[1]; //arr.slice(1);
      });
      //console.log(text);
      return obj;
    }
    function sleep(ms){
      return new Promise(resolve => setTimeout(resolve, ms));
    }
    async function animate(data){
      var ti = data.data[0].time;
      var pti = performance.now();
      for(var d of data.data){
        var tc = d.time;
        var ptc = performance.now();
        if(ptc - pti > (tc - ti) / 1000) continue;
        await sleep(100);
        render({...data, ...d});
      }
    }
    function render(data){
      console.log('Rendering...');
      var p = settings.padding;
      var w = settings.width - p * 2;
      var h = settings.height - p * 2;
      var ctx = settings.ctx;
      var yc = p;

      renderBackground();
      var rawThr = data['rcCommand[3]'];
      var thr = (2000 - rawThr) / 1000;
      var yaw = data['rcCommand[2]'] / 1000;
      var pitch = data['rcCommand[0]'] / 1000;
      var roll = data['rcCommand[1]'] / 1000;
      renderJoystick(p, yc, w / 2, w / 2, yaw, thr);
      renderJoystick(p + w / 2, yc, w / 2, w / 2, roll, pitch);
      yc += w / 2 + p * 2;
      renderText(p, yc, 'Throttle: ' + Math.round((rawThr - 1000) / 10), settings.font);
      yc += p * 4 + p;
      var vmax = (data.vbatref / 10);
      var cells = Math.round(vmax / (data.vbatmaxcellvoltage / 10));
      var vmin = (data.vbatmincellvoltage / 10) * cells;
      var vcurr = (data.vbatLatest / 10);
      console.log(vcurr, vmax, vmin, cells);
      renderProgressBar(p, yc, w, w / 8, 'Voltage', vcurr, vmin, vmax);
      yc += w / 8 + p * 4 + p;
      var amps = data.amperageLatest / 100;
      renderProgressBar(p, yc, w, w / 8, 'Amp Draw', amps, 0, 250);

      function renderRect(x, y, w, h, r, c){
        ctx.fillStyle = c;
        ctx.beginPath();
        ctx.roundRect(x, y, w, h, r);
        //ctx.stroke();
        ctx.fill();
      }
      function renderCircle(x, y, r, c){
        ctx.fillStyle = c;
        ctx.beginPath();
        ctx.arc(x, y, r, 0, 2 * Math.PI);
        //ctx.stroke();
        ctx.fill();
      }
      function renderText(x, y, text, font){
        ctx.font = font;
        ctx.fillStyle = settings.accent;
        //ctx.textBaseline = 'middle';
        ctx.textBaseline = 'top';
        ctx.fillText(text, x, y);
      }
      function renderJoystick(x, y, w, h, xv, yv){
        var thumbSize = w / 16 + h / 16;
        renderRect(x, y, w, h, settings.borderRadius, settings.background2);
        renderCircle(x + w / 2 + w * xv / 2, y + h / 2 + h * yv / 2, thumbSize, settings.color);
      }
      function renderBackground(){
        renderRect(0, 0, settings.width, settings.height, 0, settings.background);
      }
      function renderProgressBar(x, y, w, h, name, val, min, max){
        var v = (val - min) / (max - min);
        renderRect(x, y, w, h, settings.borderRadius, settings.background2);
        renderRect(x, y, v * w, h, settings.borderRadius, settings.color);
        if(name) renderText(x, y + h + p, name + ': ' + val, settings.font);
      }
    }
  </script>
</body>
</html>
