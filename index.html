<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blackbox Video Exporter</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    canvas, video{
      height: 500px; border: 1px solid #000;
    }
  </style>
</head>
<body>
  <input type="radio" id="raido1" class="compileInput" name="compile" value="true">
  <label for="raido1">Compile to WEBM</label><br>
  <input type="radio" id="radio2" class="animateInput" name="compile" value="false" checked>
  <label for="radio2">Render in real-time</label><br>
  <input type="file" class="fileInput"><br>
  <canvas class="canvas"></canvas><br>
  <script>
    window.settings = {};
    settings.fileInput = document.querySelector('.fileInput');
    settings.canvas = document.querySelector('.canvas');
    settings.canvas.width = settings.width;
    settings.canvas.height = settings.height;
    settings.ctx = settings.canvas.getContext('2d');
    settings.compileInput = document.querySelector('.compileInput');
    settings.animateInput = document.querySelector('.animateInput');
    settings.compile = false;
  </script>
  <script src="settings.js"></script>
  <script src="CSVParser.js"></script>
  <script src="Parser.js"></script>
  <script src="Renderer.js"></script>
  <script src="ctxRoundRect.js"></script>
  <script src="whammy.js"></script>
  <script>
    settings.compileInput.onchange = settings.animateInput.onchange = function(){
      if(this == settings.compileInput)
        settings.compile = true;
      if(this == settings.animateInput)
        settings.compile = false;
    }
    //https://www.geeksforgeeks.org/how-to-read-a-local-text-file-using-javascript/
    settings.fileInput.onchange = async function(){
      if(this.files.length != 1){
        throw new Error('Please only select one file.');
      }
      settings.log('Reading...');
      var reader = new FileReader();
      reader.onload = async function(){
        try{
          var data = await (Parser.parse(reader.result));
        }catch(e){
          settings.log('Error Parsing File. See console for more details.');
          settings.log('Process Halted.');
          throw e;
        }
        console.log(data);
        try{
          await animate(data, settings.compile);
        }catch(e){
          settings.log('Error Rendering Data. See console for more details.');
          settings.log('Process Halted.');
          throw e;
        }
        settings.log('Process Successful.');
      }
      try{
        reader.readAsBinaryString(this.files[0]);
      }catch(e){
        settings.log('Error Reading File. See console for more details.');
        settings.log('Process Halted.');
        throw e;
      }
      //https://stackoverflow.com/questions/3528359/html-input-type-file-file-selection-event
      settings.fileInput.value = null;
    }
    function sleep(ms){
      return new Promise(resolve => setTimeout(resolve, ms));
    }
    async function animate(data, compile){
      if(!compile) settings.log('Rendering in Real Time...');
      else settings.log('Saving Frames for Compression...');
      //https://github.com/antimatter15/whammy
      var encoder = new Whammy.Video(settings.fps);
      const ts = Math.floor(1024 / settings.fps);
      var ti = data.data[0].time;
      var pti = performance.now();
      var ptc = performance.now();
      for(var d = 0; d < data.data.length; d += ts){
        var tc = data.data[d].time;
        if(ptc - pti > (tc - ti) / 1000) continue;
        if(!compile) ptc = performance.now();
        else ptc += 1000 / settings.fps;
        await sleep(100);
        Renderer.render({...data, ...data.data[d]});
        if(compile) encoder.add(settings.ctx);
      }
      if(compile){
        settings.log('Compiling to WEBM...');
        return new Promise(function(resolve){
          encoder.compile(false, function(output){
            var url = URL.createObjectURL(output);
            var video = document.createElement('video');
            var source = document.createElement('source');
            video.controls = true;
            source.src = url;
            video.appendChild(source);
            document.body.appendChild(video);
            resolve();
          });
        });
      }
    }
  </script>
</body>
</html>
